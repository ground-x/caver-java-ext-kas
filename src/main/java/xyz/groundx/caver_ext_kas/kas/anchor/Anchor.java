/*
 * Copyright 2020 The caver-java-ext-kas Authors
 *
 * Licensed under the Apache License, Version 2.0 (the “License”);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an “AS IS” BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package xyz.groundx.caver_ext_kas.kas.anchor;

import com.squareup.okhttp.Call;
import xyz.groundx.caver_ext_kas.rest_client.io.swagger.client.ApiCallback;
import xyz.groundx.caver_ext_kas.rest_client.io.swagger.client.ApiClient;
import xyz.groundx.caver_ext_kas.rest_client.io.swagger.client.ApiException;
import xyz.groundx.caver_ext_kas.rest_client.io.swagger.client.api.anchor.api.DataAnchoringTransactionApi;
import xyz.groundx.caver_ext_kas.rest_client.io.swagger.client.api.anchor.api.OperatorApi;
import xyz.groundx.caver_ext_kas.rest_client.io.swagger.client.api.anchor.model.*;


import java.security.InvalidParameterException;
import java.util.Map;

/**
 * Representing an wrapping class tha connects Anchor APi.
 */
public class Anchor {

    /**
     * Anchor API rest-client object.
     */
    DataAnchoringTransactionApi dataAnchoringTransactionApi;

    /**
     * Operator API rest-client object.
     */
    OperatorApi operatorApi;

    /**
     * Klaytn network id.
     */
    String chainId;

    /**
     * The ApiClient for connecting with KAS.
     */
    ApiClient apiClient;

    /**
     * Creates an AnchorAPI instance
     * @param chainId A Klaytn network chain id.
     * @param anchorApiClient The Api client for connecting with KAS.
     */
    public Anchor(String chainId, ApiClient anchorApiClient) {
        setChainId(chainId);
        setApiClient(anchorApiClient);
    }

    /**
     * Sends ChainDataAnchoring transaction to the Klaytn.<br>
     * POST /v1/anchor
     *
     * <pre>Example:
     * {@code
     * String operatorAddress = "0x{operatorAddress}";
     *
     * Random random = new Random();
     * AnchorBlockPayload payload = new AnchorBlockPayload();
     * payload.put("id", Integer.toString(random.nextInt()));
     * payload.put("field", "1");
     * payload.put("filed2", 4);
     *
     * AnchorBlockStatus res = caver.kas.anchor.sendAnchoringData(operatorAddress, payload);
     * }
     * </pre>
     *
     * @param operatorId Operator address to send transaction.
     * @param payload Data to be anchored to the Klaytn.
     * @return AnchorBlockResponse
     * @throws ApiException
     */
    public AnchorBlockStatus sendAnchoringData(String operatorId, AnchorBlockPayload payload) throws ApiException {
        checkPayload(payload);

        AnchorBlockRequest anchorRequest = new AnchorBlockRequest();

        anchorRequest.setOperator(operatorId);
        anchorRequest.setPayload(payload);

        return getDataAnchoringTransactionApi().anchorBlock(getChainId(), anchorRequest);
    }

    /**
     * Sends ChainDataAnchoring transaction to the Klaytn asynchronously.<br>
     * POST /v1/anchor
     *
     * <pre>Example:
     * {@code
     * String operatorAddress = "0x{operatorAddress}";
     *
     * Random random = new Random();
     * AnchorBlockPayload payload = new AnchorBlockPayload();
     * payload.put("id", Integer.toString(random.nextInt()));
     * payload.put("field", "1");
     * payload.put("filed2", 4);
     *
     * ApiCallback<AnchorBlockStatus> callback = new ApiCallback<AnchorBlockStatus>() {
     *     ....implements callback method
     * };
     *
     * caver.kas.anchor.sendAnchoringDataAsync(operatorAddress, payload, callback);
     * }
     * </pre>
     *
     * @param operatorId Operator address to send transaction.
     * @param payload Data to be anchored to the Klaytn.
     * @param callback The callback function to handle response.
     * @return Call
     * @throws ApiException
     */
    public Call sendAnchoringDataAsync(String operatorId, AnchorBlockPayload payload, ApiCallback<AnchorBlockStatus> callback) throws ApiException {
        checkPayload(payload);

        AnchorBlockRequest anchorRequest = new AnchorBlockRequest();
        anchorRequest.setOperator(operatorId);
        anchorRequest.setPayload(payload);

        return getDataAnchoringTransactionApi().anchorBlockAsync(getChainId(), anchorRequest, callback);
    }

    /**
     * Gets anchoring transaction list generated by a given operator.<br>
     * GET /v1/operator/{operator_id}/tx
     *
     * <pre>Example:
     * {@code
     * String operatorAddress = "0x{operatorAddress}";
     * AnchorTransactions res = caver.kas.anchor.getAnchoringTransactionList(operatorAddress);
     * }
     * </pre>
     *
     * @param operatorId An operator address to query the anchoring transaction list.
     * @return RetrieveAnchorBlockResponse
     * @throws ApiException
     */
    public AnchorTransactions getAnchoringTransactionList(String operatorId) throws ApiException {
        AnchorQueryOptions params = new AnchorQueryOptions();
        return getAnchoringTransactionList(operatorId, params);
    }

    /**
     * Gets anchoring transaction list generated by a given operator.<br>
     * GET /v1/operator/{operator_id}/tx
     *
     * <pre>Example:
     * {@code
     * String operatorAddress = "0x{operatorAddress}";
     *
     * AnchorQueryOptions anchorQueryParams = new AnchorQueryOptions();
     * anchorQueryParams.setSize((long)3);
     * anchorQueryParams.setFromTimestamp("2020-10-26 15:00:00");
     * anchorQueryParams.setToDate(new Date().getTime() / 1000);
     *
     * AnchorTransactions res = caver.kas.anchor.getAnchoringTransactionList(operatorAddress, anchorQueryParams);
     * }
     * </pre>
     *
     * @param operatorId An operator address to query the anchoring transaction list.
     * @param queryParams An query options object.
     * @return RetrieveAnchorBlockResponse
     * @throws ApiException
     */
    public AnchorTransactions getAnchoringTransactionList(String operatorId, AnchorQueryOptions queryParams) throws ApiException {
        return dataAnchoringTransactionApi.retrieveAnchorBlock(getChainId(), operatorId, queryParams.getSize(), queryParams.getCursor() , queryParams.getFromTimestamp(), queryParams.getToTimestamp());
    }

    /**
     * Gets anchoring transaction list generated by a given operator asynchronously.<br>
     * GET /v1/operator/{operator_id}/tx
     *
     * <pre>Example:
     * {@code
     * String operatorAddress = "0x{operatorAddress}";
     *
     * ApiCallback<AnchorTransactions> callback = new ApiCallback<AnchorTransactions>() {
     *     ....implements callback method
     * };
     * caver.kas.anchor.getAnchoringTransactionListAsync(operatorAddress, callback);
     * }
     * </pre>
     *
     * @param operatorId An operator address to query the anchoring transaction list.
     * @param callback The callback function to handle response.
     * @return Call
     * @throws ApiException
     */
    public Call getAnchoringTransactionListAsync(String operatorId, ApiCallback<AnchorTransactions> callback) throws ApiException {
        AnchorQueryOptions params = new AnchorQueryOptions();
        return getAnchoringTransactionListAsync(operatorId, params, callback);
    }

    /**
     * Gets anchoring transaction list generated by a given operator asynchronously.<br>
     * GET /v1/operator/{operator_id}/tx
     *
     * <pre>Example:
     * {@code
     * String operatorAddress = "0x{operatorAddress}";
     *
     * AnchorQueryOptions anchorQueryParams = new AnchorQueryOptions();
     * anchorQueryParams.setSize((long)3);
     * anchorQueryParams.setFromTimestamp("2020-10-26 15:00:00");
     * anchorQueryParams.setToDate(new Date().getTime() / 1000);
     *
     * ApiCallback<AnchorTransactions> callback = new ApiCallback<AnchorTransactions>() {
     *     ....implements callback method
     * };
     *
     * caver.kas.anchor.getAnchoringTransactionListAsync(operatorAddress, anchorQueryParams, callback);
     * }
     * </pre>
     *
     * @param operatorId An operator address to query the anchoring transaction list.
     * @param queryParams A query options object.
     * @param callback The callback function to handle response.
     * @return Call
     * @throws ApiException
     */
    public Call getAnchoringTransactionListAsync(String operatorId, AnchorQueryOptions queryParams, ApiCallback<AnchorTransactions> callback) throws ApiException {
        return dataAnchoringTransactionApi.retrieveAnchorBlockAsync(getChainId(), operatorId, queryParams.getSize(), queryParams.getCursor() , queryParams.getFromTimestamp(), queryParams.getToTimestamp(), callback);
    }

    /**
     * Get anchoring transaction with the given transaction hash.<br>
     * GET /v1/operator/{operator_id}/tx/{tx_hash}
     *
     * <pre>Example:
     * {@code
     * String operatorAddress = "0x{operatorAddress}";
     * String txHash = "0x{txHash}";
     *
     * AnchorTransactionDetail res = caver.kas.anchor.getAnchoringTransactionByTxHash(operatorAddress, txHash);
     * }
     * </pre>
     *
     * @param operatorId An operator address to query the anchoring transaction.
     * @param txHash A transaction hash used for getting anchoring transaction.
     * @return AnchorTransactionDetail
     * @throws ApiException
     */
    public AnchorTransactionDetail getAnchoringTransactionByTxHash(String operatorId, String txHash) throws ApiException {
        return dataAnchoringTransactionApi.getAnchorBlockByTx(getChainId(), operatorId, txHash);
    }

    /**
     * Get anchoring transaction with the given transaction hash asynchronously.<br>
     * GET /v1/operator/{operator_id}/tx/{tx_hash}
     *
     * <pre>Example:
     * {@code
     * String operatorAddress = "0x{operatorAddress}";
     * String txHash = "0x{txHash}";
     *
     * ApiCallback<AnchorTransactionDetail> callback = new ApiCallback<AnchorTransactionDetail>() {
     *     ....implements callback method
     * };
     *
     * caver.kas.anchor.getAnchoringTransactionByTxHashAsync(operatorAddress, txHash, callback);
     * }
     * </pre>
     *
     * @param operatorId An operator address to query the anchoring transaction.
     * @param txHash A transaction hash used for getting anchoring transaction.
     * @param callback The callback function to handle response.
     * @return Call
     * @throws ApiException
     */
    public Call getAnchoringTransactionByTxHashAsync(String operatorId, String txHash, ApiCallback<AnchorTransactionDetail> callback) throws ApiException {
        return dataAnchoringTransactionApi.getAnchorBlockByTxAsync(getChainId(), operatorId, txHash, callback);
    }

    /**
     * Get anchoring transaction with the given payload id.<br>
     * GET /v1/operator/{operator_id}/payload/{payload_id}
     *
     * <pre>Example:
     * {@code
     * String operatorAddress = "0x{operatorAddress}";
     * String payloadId = "0x{payloadId}";
     *
     * AnchorTransactionDetail res = caver.kas.anchor.getAnchoringTransactionByPayloadId(operatorAddress, payloadId);
     * }
     * </pre>
     *
     * @param operatorId An operator address to query the anchoring transaction.
     * @param payloadId A payload id used for getting anchoring transaction.
     * @return AnchorTransactionDetail
     * @throws ApiException
     */
    public AnchorTransactionDetail getAnchoringTransactionByPayloadId(String operatorId, String payloadId) throws ApiException {
        return dataAnchoringTransactionApi.getAnchorBlockByPayloadID(getChainId(), operatorId, payloadId);
    }

    /**
     * Get anchoring transaction with the given payload id asynchronously.<br>
     * GET /v1/operator/{operator_id}/payload/{payload_id}
     *
     * <pre>Example:
     * {@code
     * String operatorAddress = "0x{operatorAddress}";
     * String payloadId = "0x{payloadId}";
     *
     * ApiCallback<AnchorTransactionDetail> callback = new ApiCallback<AnchorTransactionDetail>() {
     *     ....implements callback method
     * };
     *
     * caver.kas.anchor.getAnchoringTransactionByPayloadIdAsync(operatorAddress, payloadId, callback);
     * }
     * </pre>
     *
     * @param operatorId An operator address to query the anchoring transaction.
     * @param payloadId A payload id used for getting anchoring transaction.
     * @param callback The callback function to handle response.
     * @return Call
     * @throws ApiException
     */
    public Call getAnchoringTransactionByPayloadIdAsync(String operatorId, String payloadId, ApiCallback<AnchorTransactionDetail> callback) throws ApiException {
        return dataAnchoringTransactionApi.getAnchorBlockByPayloadIDAsync(getChainId(), operatorId, payloadId, callback);
    }

    /**
     * Get operator list.<br>
     * GET /v1/operator
     *
     * <pre>Example:
     * {@code
     * Operators res = caver.kas.anchor.getOperatorList();
     * }
     * </pre>
     *
     * @return RetrieveOperatorsResponse
     * @throws ApiException
     */
    public Operators getOperatorList() throws ApiException {
        AnchorQueryOptions queryParams = new AnchorQueryOptions();
        return getOperatorList(queryParams);
    }

    /**
     * Get operator list.<br>
     * GET /v1/operator
     *
     * <pre>Example:
     * {@code
     * AnchorQueryOptions anchorQueryParams = new AnchorQueryOptions();
     * anchorQueryParams.setSize((long)3);
     *
     * Operators res = caver.kas.anchor.getOperatorList(anchorQueryParams);
     * }
     * </pre>
     *
     * @param queryParams A query options object.
     * @return RetrieveOperatorsResponse
     * @throws ApiException
     */
    public Operators getOperatorList(AnchorQueryOptions queryParams) throws ApiException {
        return getOperatorApi().retrieveOperators(getChainId(), queryParams.getSize(), queryParams.getCursor(), queryParams.getFromTimestamp(), queryParams.toTimestamp);
    }

    /**
     * Get operator list asynchronously.<br>
     * GET /v1/operator
     *
     * <pre>Example:
     * {@code
     * ApiCallback<Operators> callback = new ApiCallback<Operators>() {
     *     ....implements callback method
     * };
     *
     * caver.kas.anchor.getOperatorListAsync(callback);
     * }
     * </pre>
     *
     * @param callback The callback function to handle response.
     * @return Call
     * @throws ApiException
     */
    public Call getOperatorListAsync(ApiCallback<Operators> callback) throws ApiException {
        AnchorQueryOptions queryParams = new AnchorQueryOptions();
        return getOperatorListAsync(queryParams, callback);
    }

    /**
     * Get operator list asynchronously.<br>
     * GET /v1/operator
     *
     * <pre>Example:
     * {@code
     * AnchorQueryOptions anchorQueryParams = new AnchorQueryOptions();
     * anchorQueryParams.setSize((long)3);
     *
     * ApiCallback<Operators> callback = new ApiCallback<Operators>() {
     *     ....implements callback method
     * };
     *
     * caver.kas.anchor.getOperatorListAsync(anchorQueryParams, callback);
     * }
     * </pre>
     *
     * @param queryParams A query options object.
     * @param callback The callback function to handle response.
     * @return Call
     * @throws ApiException
     */
    public Call getOperatorListAsync(AnchorQueryOptions queryParams, ApiCallback<Operators> callback) throws ApiException {
        return getOperatorApi().retrieveOperatorsAsync(getChainId(), queryParams.getSize(), queryParams.getCursor(), queryParams.getFromTimestamp(), queryParams.getToTimestamp(), callback);
    }

    /**
     * Get operator information.<br>
     * GET /v1/operator/{operator_id}
     *
     * <pre>Example:
     * {@code
     * String operatorAddress = "0x{operatorAddress}";
     *
     * Operator res = caver.kas.anchor.getOperator(operatorAddress);
     * }
     * </pre>
     *
     * @param operatorId An operator address.
     * @return GetOperatorResponse
     * @throws ApiException
     */
    public Operator getOperator(String operatorId) throws ApiException {
        return getOperatorApi().getOperator(chainId, operatorId);
    }

    /**
     * Get operator information asynchronously.<br>
     * GET /v1/operator/{operator_id}
     *
     * <pre>Example:
     * {@code
     * String operatorAddress = "0x{operatorAddress}";
     *
     * ApiCallback<Operator> callback = new ApiCallback<Operator>() {
     *     ....implements callback method
     * };
     *
     * caver.kas.anchor.getOperatorAsync(operatorAddress, callback);
     * }
     * </pre>
     *
     * @param operatorId An operator address.
     * @param callback The callback function to handle response.
     * @return Call
     * @throws ApiException
     */
    public Call getOperatorAsync(String operatorId, ApiCallback<Operator> callback) throws ApiException {
        return getOperatorApi().getOperatorAsync(chainId, operatorId, callback);
    }

    /**
     * Getter function for dataAnchoringTransactionApi.
     * @return DataAnchoringTransactionApi
     */
    public DataAnchoringTransactionApi getDataAnchoringTransactionApi() {
        return dataAnchoringTransactionApi;
    }

    /**
     * Getter function for operatorApi.
     * @return OperatorApi
     */
    public OperatorApi getOperatorApi() {
        return operatorApi;
    }

    /**
     * Getter function for chain id.
     * @return String
     */
    public String getChainId() {
        return chainId;
    }

    /**
     * Getter function for apiClient
     * @return
     */
    public ApiClient getApiClient() {
        return apiClient;
    }

    /**
     * Setter function for dataAnchoringTransactionApi
     * @param dataAnchoringTransactionApi An rest-client related Anchor API.
     */
    public void setDataAnchoringTransactionApi(DataAnchoringTransactionApi dataAnchoringTransactionApi) {
        this.dataAnchoringTransactionApi = dataAnchoringTransactionApi;
    }

    /**
     * Setter function for operatorApi
     * @param operatorApi An rest-client related Operator API.
     */
    public void setOperatorApi(OperatorApi operatorApi) {
        this.operatorApi = operatorApi;
    }

    /**
     * Setter function for chain id
     * @param chainId The klaytn network chain id.
     */
    public void setChainId(String chainId) {
        this.chainId = chainId;
    }

    /**
     * Setter function for apiClient
     * @param apiClient The ApiClient for connecting with KAS.
     */
    public void setApiClient(ApiClient apiClient) {
        this.apiClient = apiClient;
        setDataAnchoringTransactionApi(new DataAnchoringTransactionApi(apiClient));
        setOperatorApi(new OperatorApi(apiClient));
    }

    private void checkPayload(Map payload) {
        if(payload.get("id") == null) throw new NullPointerException("Payload must have an 'id' of String type.");
        if(!(payload.get("id") instanceof String)) throw new InvalidParameterException("Payload id must be String type.");
    }

}
